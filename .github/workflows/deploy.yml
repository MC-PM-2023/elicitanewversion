# name: Deploy Elicita 2.0 App to GCP

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout Repository
#         uses: actions/checkout@v4

#       - name: Install Dependencies
#         run: |
#           cd elicitafrontend
#           npm ci

#       - name: Build  React Vite App
#         run: |
#           cd elicitafrontend
#           npm run build

#       - name: Copy Files to GCP VM
#         uses: appleboy/scp-action@v0.1.4
#         with:
#           host: ${{ secrets.GCP_HOST }}
#           username: ${{ secrets.GCP_USERNAME }}
#           key: ${{ secrets.GCP_SSH_KEY }}
#           source: "elicitafrontend/dist/*"
#           target: "${{ secrets.GCP_APP_PATH }}/dist"
#           strip_components: 1

#       - name: Restart Server on GCP
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.GCP_HOST }}
#           username: ${{ secrets.GCP_USERNAME }}
#           key: ${{ secrets.GCP_SSH_KEY }}
#           script: |
#             cd ${{ secrets.GCP_APP_PATH }}
#             mkdir -p dist
#             pkill -f "serve" || true
#             nohup npx serve -s dist -l 8080 > app.log 2>&1 &
#             echo "✅ Vite app deployed successfully!"



#corrected file
# name: Deploy Elicita New Version to GCP VM

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#     # 1️⃣ Checkout repository
#     - name: Checkout code
#       uses: actions/checkout@v3

#     # 2️⃣ Install dependencies and build
#     - name: Install dependencies and build
#       run: |
#         npm install
#         npm run build

#     # 3️⃣ Debug: list files after build
#     - name: Debug - List files after build
#       run: |
#         echo "Contents of elicitafrontend after build:"
    
#     # 4️⃣ Copy project files to GCP VM
#     - name: Copy Elicita frontend to GCP Virtual Machine
#       uses: appleboy/scp-action@master
#       with:
#         host: ${{ secrets.GCP_HOST }}
#         username: ${{ secrets.GCP_USERNAME }}
#         key: ${{ secrets.GCP_SSH_KEY }}
#         source: "./*"
#         target: "~/app/elicitafrontend"

#     # 5️⃣ Build and run Docker container on VM
#     - name: Deploy and run Elicita frontend container on GCP Virtual Machine
#       uses: appleboy/ssh-action@master
#       with:
#         host: ${{ secrets.GCP_HOST }}
#         username: ${{ secrets.GCP_USERNAME }}
#         key: ${{ secrets.GCP_SSH_KEY }}
#         script: |
#           # Ensure directory exists
#           mkdir -p ~/app/elicitafrontend
#           cd ~/app/elicitafrontend

#           # Stop and remove old container
#           docker stop elicitafrontendcontainer || true
#           docker rm elicitafrontendcontainer || true

#           # Build Docker image on VM
#           docker build -t elicitafrontend:doncloud .

#           # Run container
#           docker run -d --name elicitafrontendcontainer -p 80:80 elicitafrontend:doncloud

#           # Clean up unused images
#           docker image prune -f

#           # Success message
#           echo "✅ Elicita New Version Deployed Successfully"







# name: Deploy Frontend to GCP VM

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v3

#     - name: Build frontend Docker image
#       run: |  
#         docker build -t elicitafrontend .

#     - name: Copy Docker image to GCP VM via SSH
#       uses: appleboy/scp-action@master
#       with:
#         host: ${{ secrets.GCP_HOST }}
#         username: ${{ secrets.GCP_USERNAME }}
#         key: ${{ secrets.GCP_SSH_KEY }}
#         source: "./*"
#         target: "~/app/elicitafrontend"

#     - name: Run frontend container on GCP VM via SSH
#       uses: appleboy/ssh-action@master
#       with:
#         host: ${{ secrets.GCP_VM_HOST }}
#         username: ${{ secrets.GCP_VM_USER }}
#         key: ${{ secrets.GCP_SSH_KEY }}
#         script: |
#           cd ~/app/elicitafrontend
#           docker stop elicitafrontendcontainer || true
#           docker rm elicitafrontendcontainer || true
#           docker build -t elicitafrontend .
#           docker run -d --name elicitafrontendcontainer -p 80:80 elicitafrontend
#             echo "Elicita 2.0  Vite app deployed successfully"



name: Deploy Frontend to GCP VM

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build frontend Docker image locally
      run: |
        docker build -t elicitafrontend .

    - name: Copy frontend source to GCP VM via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.GCP_HOST }}        # your VM IP
        username: ${{ secrets.GCP_USERNAME }}# your VM username
        key: ${{ secrets.GCP_SSH_KEY }}      # your private key
        source: "./*"                         # folder with your app
        target: "~/app/elicitafrontend"

    - name: Run frontend container on GCP VM via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.GCP_HOST }}        # same VM IP
        username: ${{ secrets.GCP_USERNAME }}# same VM username
        key: ${{ secrets.GCP_SSH_KEY }}
        script: |
          cd ~/app/elicitafrontend
          docker stop elicitafrontendcontainer || true
          docker rm elicitafrontendcontainer || true
          docker build -t elicitafrontend .
          docker run -d --name elicitafrontendcontainer -p 80:80 elicitafrontend
          echo "Elicita 2.0 Vite app deployed successfully"
