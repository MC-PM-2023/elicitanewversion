# name: Deploy Elicita 2.0 App to GCP

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout Repository
#         uses: actions/checkout@v4

#       - name: Install Dependencies
#         run: |
#           cd elicitafrontend
#           npm ci

#       - name: Build  React Vite App
#         run: |
#           cd elicitafrontend
#           npm run build

#       - name: Copy Files to GCP VM
#         uses: appleboy/scp-action@v0.1.4
#         with:
#           host: ${{ secrets.GCP_HOST }}
#           username: ${{ secrets.GCP_USERNAME }}
#           key: ${{ secrets.GCP_SSH_KEY }}
#           source: "elicitafrontend/dist/*"
#           target: "${{ secrets.GCP_APP_PATH }}/dist"
#           strip_components: 1

#       - name: Restart Server on GCP
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.GCP_HOST }}
#           username: ${{ secrets.GCP_USERNAME }}
#           key: ${{ secrets.GCP_SSH_KEY }}
#           script: |
#             cd ${{ secrets.GCP_APP_PATH }}
#             mkdir -p dist
#             pkill -f "serve" || true
#             nohup npx serve -s dist -l 8080 > app.log 2>&1 &
#             echo "✅ Vite app deployed successfully!"
name: Deploy Elicita New Version to GCP VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout code
      uses: actions/checkout@v3

    # 2️⃣ Install dependencies and build
    - name: Install dependencies and build
      run: |
        cd elicitafrontend
        npm install
        npm run build

    # 3️⃣ Debug: list files after build
    - name: Debug - List files after build
      run: |
        echo "Contents of elicitafrontend after build:"
        ls -R elicitafrontend

    # 4️⃣ Copy project files to GCP VM
    - name: Copy Elicita frontend to GCP Virtual Machine
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.GCP_HOST }}
        username: ${{ secrets.GCP_USERNAME }}
        key: ${{ secrets.GCP_SSH_KEY }}
        source: "elicitafrontend/**"
        target: "~/app/elicitafrontend"

    # 5️⃣ Build and run Docker container on VM
    - name: Deploy and run Elicita frontend container on GCP Virtual Machine
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.GCP_HOST }}
        username: ${{ secrets.GCP_USERNAME }}
        key: ${{ secrets.GCP_SSH_KEY }}
        script: |
          # Ensure directory exists
          mkdir -p ~/app/elicitafrontend
          cd ~/app/elicitafrontend

          # Stop and remove old container
          docker stop elicitafrontendcontainer || true
          docker rm elicitafrontendcontainer || true

          # Build Docker image on VM
          docker build -t elicitafrontend:doncloud .

          # Run container
          docker run -d --name elicitafrontendcontainer -p 80:80 elicitafrontend:doncloud

          # Clean up unused images
          docker image prune -f

          # Success message
          echo "✅ Elicita New Version Deployed Successfully"
